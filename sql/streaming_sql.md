# Streaming SQL meets OLAP

Streaming SQL 和 OLAP 是数据处理两个最有趣和强大的范例。OLAP是一种用于分析大规模历史数据的成熟技术。Streaming SQL是一个更具有创新的技术，它将 SQL 语言的声明性功能应用于管理动态数据的问题。

那么，当OLAP和Streaming SQL结合的时候将会发生什么呢？这种组合能够解决一种其他方式都无法解决的业务问题。OLAP 通常受到传统 ETL 技术的阻碍：使数据仓库保持最新很困难，因为基于批处理的 ETL 流程仅在处理几个小时或几天的数据时才有效。OLAP 引擎擅长比较时间段（例如，本季度与去年同期）或可比较数据集（例如，该品牌与该品牌）之间的比较； 当由流式 SQL 引擎提供支持时，OLAP 引擎还可以在其分析中包含最新数据（例如，与过去 6 个月中一天中这一小时的平均值进行比较）。

在企业中，最有价值的数据是代表企业当前正在发生的事情的数据。这些数据包括各种远程过程调用、关键系统的状态变化以及各种业务事件。这些数据不存储在磁盘上——我们称之为动态数据，而不是传统的静态数据——传统的 ETL 很难访问它。流式 SQL 允许您将此数据转换为与其他企业数据相同的格式，但保留实时分析和操作的能力。

我将期待如何将 mondrian OLAP 引擎与SQLstream Streaming SQL 引擎结合起来。

Mondrian 要求其数据存储在关系数据库中。 为了确保大型数据集的高性能，mondrian 将查询结果缓存在内存中，并且还使用已填充数据摘要的聚合表。 如果mondrian要在快速变化的数据集上给出正确的答案，mondrian的cache和aggregate tables都需要仔细管理。

SQLstream 通过提供连续、实时的 ETL 流程来帮助 mondrian 实现这一点。 正如我们将看到的，步骤是： 获取实时数据并将其公开为通用关系格式； 转型为适合OLAP和数据仓库的组织； 加载到数据仓库中，包括聚合表； 并通知 mondrian 其缓存的更改。

首先，SQLstream可以帮助获取数据。 正如我们之前所说，传统的 ETL 流程仅限于读取静态数据：从数据库、大型机以及从其他操作系统提取的文件。 传输中的数据以其他格式存在：面向消息的中间件上的消息、Web 服务调用、TCP 网络数据包等。 SQLstream 可以订阅这些数据源，也可以利用传统的数据仓库源：它可以监视数据库表并在新事务发生时生成事件，并跟踪日志文件以在行附加到日志文件时读取行。

SQLstream 的核心概念之一是流。 流类似于关系数据库中的表； 但是，表包含过去某个时间插入并存储在磁盘上的有限行集，而流则包含无限的行序列，每当生产者决定发送它们时，这些行就会到达。 （SQLstream 实际上也支持表，以便您可以将历史或参考数据与事件数据结合起来。）

流和表的共同点是您可以使用 SQL 查询来操作它们。 不仅仅是filtering和routing等简单操作，还有join和aggregation等组合多行的操作。 您可以将行与同一流中的其他行（通常由感兴趣的时间窗口划分）、其他流中的行以及历史和参考数据组合起来。

接下来，您需要准备数据并将其转换为适合大规模分析的形式。 在SQLstream中，您可以使用SQL来执行实时、连续的ETL过程。 例如：

- 您可以应用标准 SQL 运算符来清理和转换数据字段
- 您可以使用 SQLstream 的窗口聚合操作来计算趋势，例如正在移动平均值。
- 如果您的数据仓库架构包含缓慢变化的维度，SQLstream 可以通过识别代表维度新成员的事务来帮助加载过程。 例如，当收到现有客户的订单时，SQLstream 可以找到该客户的 ID，而如果客户是新客户，它可以生成新的代理键值。
- 如果您的数据仓库模式包含聚合表，则需要用代表多个事实表记录的记录来填充它们。 在内存中计算这些聚合记录通常更便宜。

关于聚合表，请注意，如果您有许多聚合表并且数据速率极高，最终 DBMS 的 I/O 容量将导致无法使聚合表保持 100% 最新。 您应该减少聚合表的数量或粒度，并按时间对每个聚合表进行分区，以确保每个聚合表中只有一个块被主动写入，因此聚合表的活动块可以放入 DBMS 的缓冲区缓存中。

加载数据仓库非常简单。 SQLstream 有一个数据库适配器，可以使 DBMS 表显示为外部流； 写入这些流会导致数据仓库中发生插入、更新或删除操作。

当数据加载到数据仓库时，它与 mondrian 缓存的状态不一致。 如果 mondrian 有很多并发用户或者数据仓库太大以至于 SQL 查询需要很长时间，那么 Mondrian 的缓存对于性能来说是必要的，但每次有更新时刷新整个缓存会否定缓存的价值。

幸运的是，mondrian 有一个 API，可以让您通知 mondrian 影响其缓存内容的更改。 你可以具体告诉 mondrian 哪些数据发生了变化； 例如，您可以说“德克萨斯州刚刚出售了啤酒”，mondrian 会准确地将缓存中的这些条目标记为无效，因此下次 OLAP 查询请求它们时将从数据库中重新读取它们。

再次，使用外部流可以轻松解决该问题。 外部流应该为它接收的每一行调用 mondrian 的缓存控制 API； SQLstream pump对象确保写入事实表的每条记录都镜像到外部流中，因此mondrian的缓存与DBMS保持同步。

总之，OLAP 和流式 SQL 技术之间存在协同作用，可以更有效地解决新的业务问题和现有的问题。 SQLstream 为各种方式的连续 ETL 操作提供了一个平台，而 mondrian 及其开源许可证和可扩展的 Java 架构是自然的选择。

来源：http://blog.hydromatic.net/2008/02/27/streaming-sql-meets-olap.html